<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Horaires ProDigital</title>
    
    <meta name="theme-color" content="#764ba2">
    <meta name="description" content="Application de gestion des horaires avec QR code et selfie automatique">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GestionHoraires">
    
    <link rel="icon" href="icons/icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <section id="loginSection" class="section active">
        <div class="login-container">
            <h1>üîê Gestion Horaires ProDigital</h1>
            
            <div class="demo-account">
                <div class="demo-info">
                    <h3>Compte Administrateur</h3>
                    <p><strong>Email:</strong> prodigital318@gmail.com</p>
                    <p><strong>Mot de passe:</strong> 12345678</p>
                </div>
            </div>
            
            <div class="form-group">
                <input type="email" id="loginEmail" placeholder="Email" value="prodigital318@gmail.com" required>
                <input type="password" id="loginPassword" placeholder="Mot de passe" value="12345678" required>
            </div>
            
            <button onclick="login()" class="btn-primary">Se connecter</button>
            
            <div class="login-options">
                <p><a href="#" onclick="showSetup()">Cr√©er un nouveau compte admin</a></p>
            </div>
        </div>
    </section>

    <section id="setupSection" class="section">
        <div class="setup-container">
            <h1>üëë Cr√©ation Administrateur</h1>
            <div class="form-group">
                <input type="text" id="adminName" placeholder="Nom complet" required>
                <input type="email" id="adminEmail" placeholder="Email" required>
                <input type="password" id="adminPassword" placeholder="Mot de passe (min 6 caract√®res)" required>
            </div>
            <button onclick="createFirstAdmin()" class="btn-success">Cr√©er l'administration</button>
            <button onclick="showLogin()" class="btn-secondary">Retour</button>
        </div>
    </section>

    <section id="adminSection" class="section">
        <header class="admin-header">
            <h1>üë®‚Äçüíº Administration</h1>
            <div class="user-info">
                <span id="adminUserName"></span>
                <button onclick="logout()" class="btn-logout">D√©connexion</button>
            </div>
        </header>

        <nav class="admin-nav">
            <button class="nav-btn active" onclick="showAdminTab('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="showAdminTab('employes')">üë• Employ√©s</button>
            <button class="nav-btn" onclick="showAdminTab('pointages')">‚è±Ô∏è Pointages</button>
            <button class="nav-btn" onclick="showAdminTab('qr')">üì± QR Codes</button>
            <button class="nav-btn" onclick="showAdminTab('administration')">‚öôÔ∏è Administration</button>
        </nav>

        <main class="admin-content">
            <div id="adminContent"></div>
        </main>
    </section>

    <section id="employeSection" class="section">
        <header class="employe-header">
            <h1>üë§ Espace Employ√©</h1>
            <div class="user-info">
                <span id="employeUserName"></span>
                <button onclick="logout()" class="btn-logout">D√©connexion</button>
            </div>
        </header>

        <div class="employe-content">
            <div id="employeContent"></div>
        </div>
    </section>

    <section id="cameraSection" class="section">
        <div class="camera-container">
            <video id="cameraVideo" autoplay playsinline></video>
            <div class="camera-controls">
                <p>üì∏ Selfie automatique dans <span id="countdown">3</span> secondes...</p>
                <button onclick="stopCamera()" class="btn-danger">Annuler</button>
            </div>
        </div>
    </section>

    <div id="offlineNotification" class="offline-notification" style="display: none;">
        ‚ö†Ô∏è Vous √™tes hors ligne
    </div>

    <script src="db.js"></script>
    <script src="backup.js"></script>
    <script src="camera.js"></script>
    <script src="qr.js"></script>
    <script src="admin.js"></script>
    <script src="employe.js"></script>
    
    <script>
        let deferredPrompt;
        let currentUser = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPromotion();
        });

        function showInstallPromotion() {
            if (currentUser?.role === 'admin') {
                const installBtn = document.createElement('button');
                installBtn.textContent = 'üì± Installer l\'app';
                installBtn.className = 'btn-success';
                installBtn.style.margin = '10px';
                installBtn.onclick = installPWA;
                
                const header = document.querySelector('.admin-header');
                if (header && !header.querySelector('.install-btn')) {
                    installBtn.classList.add('install-btn');
                    header.appendChild(installBtn);
                }
            }
        }

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('‚úÖ PWA install√©e');
                }
                deferredPrompt = null;
            }
        }

        window.addEventListener('online', () => {
            document.getElementById('offlineNotification').style.display = 'none';
        });

        window.addEventListener('offline', () => {
            document.getElementById('offlineNotification').style.display = 'block';
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function showLogin() { showSection('loginSection'); }
        function showSetup() { showSection('setupSection'); }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const user = await authenticateUser(email, password);
            
            if (user) {
                currentUser = user;
                if (user.role === 'admin') {
                    showSection('adminSection');
                    initAdminInterface();
                    initBackupSystem();
                } else {
                    showSection('employeSection');
                    initEmployeInterface();
                }
            } else {
                alert('‚ùå Email ou mot de passe incorrect');
            }
        }

        async function createFirstAdmin() {
            const name = document.getElementById('adminName').value;
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!name || !email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            if (password.length < 6) {
                alert('Le mot de passe doit faire au moins 6 caract√®res');
                return;
            }

            const admin = {
                name: name,
                email: email,
                password: password,
                role: 'admin',
                createdAt: new Date().toISOString()
            };

            await createUser(admin);
            alert('‚úÖ Administrateur cr√©√© ! Vous pouvez maintenant vous connecter.');
            showLogin();
        }

        function logout() {
            currentUser = null;
            showLogin();
        }

        async function initApp() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/service-worker.js');
                    console.log('‚úÖ Service Worker enregistr√©');
                } catch (error) {
                    console.log('‚ùå Service Worker non support√©:', error);
                }
            }

            await initDB();
            showLogin();
        }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
          </html>
